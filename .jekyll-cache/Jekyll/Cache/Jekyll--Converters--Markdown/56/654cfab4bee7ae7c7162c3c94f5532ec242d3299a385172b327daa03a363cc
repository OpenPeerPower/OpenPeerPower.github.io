I"¤<p>Many Linux distributions use the Upstart system (or similar) for managing daemons. Typically, systems based on Debian 7 or previous use Upstart. This includes Ubuntu releases before 15.04. If you are unsure if your system is using Upstart, you may check with the following command:</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ps -p 1 -o comm=</code></pre></figure>
<p>If the preceding command returns the string <code>init</code>, you are likely using Upstart.</p>
<p>Upstart will launch init scripts that are located in the directory <code>/etc/init.d/</code>. A sample init script for systems using Upstart could look like the sample below.</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">#!/bin/sh
### BEGIN INIT INFO
# Provides:          hass
# Required-Start:    $local_fs $network $named $time $syslog
# Required-Stop:     $local_fs $network $named $time $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Description:       Home\ Assistant
### END INIT INFO
<h1>/etc/init.d Service Script for Open Peer Power</h1>
<h1>Created with: <a href="https://gist.github.com/naholyr/4275302#file-new-service-sh">https://gist.github.com/naholyr/4275302#file-new-service-sh</a></h1>
<h1></h1>
<h1>Installation:</h1>
<h1>1) If any commands need to run before executing hass (like loading a</h1>
<h1>virtual environment), put them in PRE_EXEC. This command must end with</h1>
<h1>a semicolon.</h1>
<h1>2) Set RUN_AS to the username that should be used to execute hass.</h1>
<h1>3) Copy this script to /etc/init.d/</h1>
<h1>sudo cp hass-daemon /etc/init.d/hass-daemon</h1>
<h1>sudo chmod +x /etc/init.d/hass-daemon</h1>
<h1>4) Register the daemon with Linux</h1>
<h1>sudo update-rc.d hass-daemon defaults</h1>
<h1>5) Install this service</h1>
<h1>sudo service hass-daemon install</h1>
<h1>6) Restart Machine</h1>
<h1></h1>
<h1>After installation, HA should start automatically. If HA does not start,</h1>
<h1>check the log file output for errors.</h1>
<h1>/var/opt/openpeerpower/open-peer-power.log</h1>
<p>PRE_EXEC=&quot;&quot;
RUN_AS=&quot;USER&quot;
PID_FILE=&quot;/var/run/hass.pid&quot;
CONFIG_DIR=&quot;/var/opt/openpeerpower&quot;
FLAGS=&quot;-v â€“config $CONFIG_DIR â€“pid-file $PID_FILE â€“daemon&quot;
REDIRECT=&quot;&gt; $CONFIG_DIR/open-peer-power.log 2&gt;&amp;1&quot;</p>
<p>start() {
if [ -f $PID_FILE ] &amp;&amp; kill -0 $(cat $PID_FILE) 2&gt; /dev/null; then
echo 'Service already running' &gt;&amp;2
return 1
fi
echo 'Starting serviceâ€¦' &gt;&amp;2
local CMD=&quot;$PRE_EXEC hass $FLAGS $REDIRECT;&quot;
su -c &quot;$CMD&quot; $RUN_AS
echo 'Service started' &gt;&amp;2
}</p>
<p>stop() {
if [ ! -f &quot;$PID_FILE&quot; ] || ! kill -0 $(cat &quot;$PID_FILE&quot;) 2&gt; /dev/null; then
echo 'Service not running' &gt;&amp;2
return 1
fi
echo 'Stopping serviceâ€¦' &gt;&amp;2
kill -3 $(cat &quot;$PID_FILE&quot;)
while ps -p $(cat &quot;$PID_FILE&quot;) &gt; /dev/null 2&gt;&amp;1; do sleep 1;done;
echo 'Service stopped' &gt;&amp;2
}</p>
<p>install() {
echo &quot;Installing Open Peer Power Daemon (hass-daemon)&quot;
echo &quot;999999&quot; &gt; $PID_FILE
chown $RUN_AS $PID_FILE
mkdir -p $CONFIG_DIR
chown $RUN_AS $CONFIG_DIR
}</p>
<p>uninstall() {
echo -n &quot;Are you really sure you want to uninstall this service? That cannot be undone. [yes|No] &quot;
local SURE
read SURE
if [ &quot;$SURE&quot; = &quot;yes&quot; ]; then
stop
rm -fv &quot;$PID_FILE&quot;
echo &quot;Notice: The config directory has not been removed&quot;
echo $CONFIG_DIR
update-rc.d -f hass-daemon remove
rm -fv &quot;$0&quot;
echo &quot; Open Peer Power Daemon has been removed. Open Peer Power is still installed.&quot;
fi
}</p>
<p>case &quot;$1&quot; in
start)
start
;;
stop)
stop
;;
install)
install
;;
uninstall)
uninstall
;;
restart)
stop
start
;;
*)
echo &quot;Usage: $0 {start|stop|restart|install|uninstall}&quot;
esac</code></pre></figure></p>
<p>To install this script, download it, tweak it to you liking, and install it by following the directions in the header. This script will setup Open Peer Power to run when the system boots. To start/stop Open Peer Power manually, issue the following commands:</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo service hass-daemon start
sudo service hass-daemon stop</code></pre></figure>
<p>When running Open Peer Power with this script, the configuration directory will be located at <code>/var/opt/openpeerpower</code>. This directory will contain a verbose log rather than simply an error log.</p>
<p>When running daemons, it is good practice to have the daemon run under its own username rather than the default userâ€™s name. Instructions for setting this up are outside the scope of this document.</p>
:ET