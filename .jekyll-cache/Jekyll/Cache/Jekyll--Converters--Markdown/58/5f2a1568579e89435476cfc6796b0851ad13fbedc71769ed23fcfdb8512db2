I".<p>Scripts are a sequence of actions that Open Peer Power will execute. Scripts are available as an entity through the standalone <a href="/integrations/script/">Script component</a> but can also be embedded in <a href="/getting-started/automation-action/">automations</a> and <a href="/integrations/alexa/">Alexa/Amazon Echo</a> configurations.</p>
<p>The script syntax basic structure is a list of key/value maps that contain actions. If a script contains only 1 action, the wrapping list can be omitted.</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"># Example script integration containing script syntax
script:
  example_script:
    sequence:
      # This is written using the Script Syntax
      - service: light.turn_on
        data:
          entity_id: light.ceiling
      - service: notify.notify
        data:
          message: &#39;Turned on the ceiling light!&#39;</code></pre></figure>
<h3>Call a Service</h3>
<p>The most important one is the action to call a service. This can be done in various ways. For all the different possibilities, have a look at the <a href="/getting-started/scripts-service-calls/">service calls page</a>.</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">- alias: Bedroom lights on
  service: light.turn_on
  data:
    entity_id: group.bedroom
    brightness: 100</code></pre></figure>
<h4>Activate a Scene</h4>
<p>Scripts may also use a shortcut syntax for activating scenes instead of calling the <code>scene.turn_on</code> service.</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">- scene: scene.morning_living_room</code></pre></figure>
<h3>Test a Condition</h3>
<p>While executing a script you can add a condition to stop further execution. When a condition does not return <code>true</code>, the script will stop executing. There are many different conditions which are documented at the <a href="/getting-started/scripts-conditions/">conditions page</a>.</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"># If paulus is home, continue to execute the script below these lines
- condition: state
  entity_id: device_tracker.paulus
  state: &#39;home&#39;</code></pre></figure>
<h3>Delay</h3>
<p>Delays are useful for temporarily suspending your script and start it at a later moment. We support different syntaxes for a delay as shown below.</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"># Waits 1 hour
- delay: &#39;01:00&#39;</code></pre></figure>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"># Waits 1 minute, 30 seconds
- delay: &#39;00:01:30&#39;</code></pre></figure>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"># Waits 1 minute
- delay:
    # Supports milliseconds, seconds, minutes, hours, days
    minutes: 1</code></pre></figure>
<p>{% highlight yaml %}</p>
<h1>Waits however many seconds input_number.second_delay is set to</h1>
<ul>
<li>delay:
<h1>Supports milliseconds, seconds, minutes, hours, days</h1>
seconds: “{{ states(‘input_number.second_delay’) | int }}”
{% endhighlight %}</li>
</ul>
<p>{% highlight yaml %}</p>
<h1>Waits however many minutes input_number.minute_delay is set to</h1>
<h1>Valid formats include HH:MM and HH:MM:SS</h1>
<ul>
<li>delay: “{{ states(‘input_number.minute_delay’) | multiply(60) | timestamp_custom(’%H:%M:%S’,False) }}”
{% endhighlight %}</li>
</ul>
<h3>Wait</h3>
<p>Wait until some things are complete. We support at the moment <code>wait_template</code> for waiting until a condition is <code>true</code>, see also on <a href="/docs/automation/trigger/#template-trigger">Template-Trigger</a>. It is possible to set a timeout after which the script will continue its execution if the condition is not satisfied. Timeout has the same syntax as <code>delay</code>.</p>
<p>{% highlight yaml %}</p>
<h1>Wait until media player have stop the playing</h1>
<ul>
<li>wait_template: “{{ is_state(‘media_player.floor’, ‘stop’) }}”
{% endhighlight %}</li>
</ul>
<p>{% highlight yaml %}</p>
<h1>Wait for sensor to trigger or 1 minute before continuing to execute.</h1>
<ul>
<li>wait_template: “{{ is_state(‘binary_sensor.entrance’, ‘on’) }}”
timeout: ‘00:01:00’
{% endhighlight %}</li>
</ul>
<p>When using <code>wait_template</code> within an automation <code>trigger.entity_id</code> is supported for <code>state</code>, <code>numeric_state</code> and <code>template</code> triggers, see also <a href="/docs/automation/templating/#available-trigger-data">Available-Trigger-Data</a>.</p>
<p>{% highlight yaml %}</p>
<ul>
<li>wait_template: “{{ is_state(trigger.entity_id, ‘on’) }}”
{% endhighlight %}</li>
</ul>
<p>It is also possible to use dummy variables, e.g., in scripts, when using <code>wait_template</code>.</p>
<p>{% highlight yaml %}</p>
<h1>Service call, e.g., from an automation.</h1>
<ul>
<li>service: script.do_something
data_template:
dummy: input_boolean.switch</li>
</ul>
<h1>Inside the script</h1>
<ul>
<li>wait_template: “{{ is_state(dummy, ‘off’) }}”
{% endhighlight %}</li>
</ul>
<p>You can also get the script to abort after the timeout by using optional <code>continue_on_timeout</code></p>
<p>{% highlight yaml %}</p>
<h1>Wait until a valve is &lt; 10 or abort after 1 minute.</h1>
<ul>
<li>wait_template: “{{ state_attr(‘climate.kitchen’, ‘valve’)|int &lt; 10 }}”
timeout: ‘00:01:00’
continue_on_timeout: ‘false’
{% endhighlight %}</li>
</ul>
<p>Without <code>continue_on_timeout</code> the script will always continue.</p>
<h3>Fire an Event</h3>
<p>This action allows you to fire an event. Events can be used for many things. It could trigger an automation or indicate to another integration that something is happening. For instance, in the below example it is used to create an entry in the logbook.</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">- event: LOGBOOK_ENTRY
  event_data:
    name: Paulus
    message: is waking up
    entity_id: device_tracker.paulus
    domain: light</code></pre></figure>
<p>You can also use event_data_template to fire an event with custom data. This could be used to pass data to another script awaiting
an event trigger.</p>
<p>{% highlight yaml %}</p>
<ul>
<li>event: MY_EVENT
event_data_template:
name: myEvent
customData: “{{ myCustomVariable }}”
{% endhighlight %}</li>
</ul>
<h3>Raise and Consume Custom Events</h3>
<p>The following automation shows how to raise a custom event called <code>event_light_state_changed</code> with <code>entity_id</code> as the event data. The action part could be inside a script or an automation.</p>
<p>{% highlight yaml %}</p>
<ul>
<li>alias: Fire Event
trigger:
<ul>
<li>platform: state
entity_id: switch.kitchen
to: ‘on’
action:</li>
<li>event: event_light_state_changed
event_data:
state: ‘on’
{% endhighlight %}</li>
</ul>
</li>
</ul>
<p>The following automation shows how to capture the custom event <code>event_light_state_changed</code>, and retrieve corresponding <code>entity_id</code> that was passed as the event data.</p>
<p>{% highlight yaml %}</p>
<ul>
<li>alias: Capture Event
trigger:
<ul>
<li>platform: event
event_type: event_light_state_changed
action:</li>
<li>service: notify.notify
data_template:
message: “kitchen light is turned {{ trigger.event.data.state }}”
{% endhighlight %}</li>
</ul>
</li>
</ul>
:ET