I"" <p>The <a href="https://www.mysensors.org">MySensors</a> project combines devices like Arduino, ESP8266, Raspberry Pi, NRF24L01+ and RFM69 to build affordable sensor networks. This integration will automatically add all available devices to Open Peer Power, after <a href="#presentation">presentation</a> is done. That is, you do not need to add anything to your configuration for the devices for them to be added. Go to the <strong>states</strong> section of the developer tools to find the devices that have been identified.</p>
<h2>Configuration</h2>
<p>Integrate your Serial, Ethernet (LAN) or MQTT MySensors Gateway by adding the following to your <code>configuration.yaml</code> file:</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"># Example configuration.yaml entry
mysensors:
  gateways:
    - device: &#39;/dev/ttyUSB0&#39;</code></pre></figure>
<div class='note'>
Not all features of MySensors 2.x are supported by Open Peer Power yet. As more features are added, they will be described here in the documentation. Go to the MySensors platform pages under "related components" to see what message types are currently supported.
</div>
<p>If you are using an original Arduino as a serial gateway, the port will be named <code>ttyACM*</code>. The exact number can be determined with the command shown below.</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">ls /dev/ttyACM*</code></pre></figure>
<p>If you are using the MQTT gateway, you also need to have the <a href="/integrations/mqtt/">MQTT component</a> configured in Open Peer Power. See below for a minimum MQTT configuration:</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">mqtt:
  client_id: open-peer-power-1</code></pre></figure>
<div class='note'>
The MQTT gateway requires MySensors version 2.0+ and only the MQTT client gateway is supported.
</div>
<h3>Extended configuration example</h3>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"># Example configuration.yaml entry
mysensors:
  gateways:
    - device: &#39;/dev/ttyUSB0&#39;
      persistence_file: &#39;path/mysensors.json&#39;
      baud_rate: 38400
      nodes:
        1:
          name: &#39;kitchen&#39;
        3:
          name: &#39;living_room&#39;
    - device: &#39;/dev/ttyACM0&#39;
      persistence_file: &#39;path/mysensors2.json&#39;
      baud_rate: 115200
    - device: &#39;192.168.1.18&#39;
      persistence_file: &#39;path/mysensors3.json&#39;
      tcp_port: 5003
    - device: mqtt
      persistence_file: &#39;path/mysensors4.json&#39;
      topic_in_prefix: &#39;mygateway1-out&#39;
      topic_out_prefix: &#39;mygateway1-in&#39;
  optimistic: false
  persistence: true
  retain: true
  version: &#39;2.0&#39;</code></pre></figure>
<h3>Presentation</h3>
<p>Present a MySensors sensor or actuator, by following these steps:</p>
<ol>
<li>Connect the serial gateway to your computer or the Ethernet or MQTT gateway to your network.</li>
<li>Configure the MySensors integration in <code>configuration.yaml</code>.</li>
<li>Start Open Peer Power.</li>
<li>Write and upload your MySensors sketch to the sensor. Make sure you:
<ul>
<li>Send sketch name.</li>
<li>Present the sensor’s <code>S_TYPE</code>.</li>
<li>Send at least one initial value per <code>V_TYPE</code>. In version 2.x of MySensors, this has to be done in the loop function. See below for an example in 2.0 of how to make sure the initial value has been received by the controller.</li>
</ul>
</li>
<li>Start the sensor.</li>
</ol>
<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp">/*
 * Documentation: https://www.mysensors.org
 * Support Forum: https://forum.mysensors.org
 *
 * https://www.mysensors.org/build/relay
 */
<p>#define MY_DEBUG
#define MY_RADIO_NRF24
#define MY_REPEATER_FEATURE
#define MY_NODE_ID 1
#include &lt;SPI.h&gt;
#include &lt;MySensors.h&gt;
#include &lt;Bounce2.h&gt;</p>
<p>#define RELAY_PIN  5
#define BUTTON_PIN  3
#define CHILD_ID 1
#define RELAY_ON 1
#define RELAY_OFF 0</p>
<p>Bounce debouncer = Bounce();
bool state = false;
bool initialValueSent = false;</p>
<p>MyMessage msg(CHILD_ID, V_STATUS);</p>
<p>void setup()
{
pinMode(BUTTON_PIN, INPUT_PULLUP);
debouncer.attach(BUTTON_PIN);
debouncer.interval(10);</p>
<p>// Make sure relays are off when starting up
digitalWrite(RELAY_PIN, RELAY_OFF);
pinMode(RELAY_PIN, OUTPUT);
}</p>
<p>void presentation()  {
sendSketchInfo(&quot;Relay+button&quot;, &quot;1.0&quot;);
present(CHILD_ID, S_BINARY);
}</p>
<p>void loop()
{
if (!initialValueSent) {
Serial.println(&quot;Sending initial value&quot;);
send(msg.set(state?RELAY_ON:RELAY_OFF));
Serial.println(&quot;Requesting initial value from controller&quot;);
request(CHILD_ID, V_STATUS);
wait(2000, C_SET, V_STATUS);
}
if (debouncer.update()) {
if (debouncer.read()==LOW) {
state = !state;
// Send new state and request ack back
send(msg.set(state?RELAY_ON:RELAY_OFF), true);
}
}
}</p>
<p>void receive(const MyMessage &amp;message) {
if (message.isAck()) {
Serial.println(&quot;This is an ack from gateway&quot;);
}</p>
<p>if (message.type == V_STATUS) {
if (!initialValueSent) {
Serial.println(&quot;Receiving initial value from controller&quot;);
initialValueSent = true;
}
// Change relay state
state = (bool)message.getInt();
digitalWrite(RELAY_PIN, state?RELAY_ON:RELAY_OFF);
send(msg.set(state?RELAY_ON:RELAY_OFF));
}
}</code></pre></figure></p>
<h3>SmartSleep</h3>
<p>Sending a heartbeat, <code>I_HEARTBEAT_RESPONSE</code>, from the MySensors device to Open Peer Power, using MySensors version 2.0 - 2.1, activates the SmartSleep functionality in Open Peer Power. This means that messages are buffered and only sent to the device upon receiving a heartbeat from the device. State changes are stored so that only the last requested state change is sent to the device. Other types of messages are queued in a FIFO queue. SmartSleep is useful for battery powered actuators that are waiting for commands. See the MySensors library API for information on how to send heartbeats and sleep the device.</p>
<p>In MySensors version 2.2 the serial API changed from using <code>I_HEARTBEAT_RESPONSE</code> to signal SmartSleep, to using <code>I_PRE_SLEEP_NOTIFICATION</code> and <code>I_POST_SLEEP_NOTIFICATION</code>. Open Peer Power has been upgraded to support the new message types and will activate SmartSleep when receiving a message of type <code>I_PRE_SLEEP_NOTIFICATION</code>, if using MySensors version 2.2.x or higher. If Open Peer Power is configured to use MySensors version 2.0 - 2.1 the old SmartSleep behavior is retained.</p>
<h3>Message validation</h3>
<p>Messages sent to or from Open Peer Power from or to a MySensors device will be validated according to the MySensors <a href="https://www.mysensors.org/download/serial_api_20">serial API</a>. If a message doesn’t pass validation, it will be dropped and not be passed forward either to or from Open Peer Power. Make sure you follow the serial API for your version of MySensors when writing your Arduino sketch.</p>
<p>The log should warn you of messages that failed validation or if a child value is missing that is required for a certain child type. Open Peer Power will log failed validations of child values at warning level if e.g.,  one required value type for a platform has been received, but other required value types are missing.</p>
<p>Message validation was introduced in version 0.52 of Open Peer Power.</p>
<h3>Debug logging</h3>
<p>If you experience dropped messages or that a device is not added to Open Peer Power, please turn on debug logging for the <code>mysensors</code> integration and the <code>mysensors</code> package. This will help you see what is going on. Make sure you use these logging settings to collect a log sample if you report an issue about the <code>mysensors</code> integration in our GitHub issue tracker.</p>
<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml">logger:
  default: info
  logs:
    openpeerpower.components.mysensors: debug
    mysensors: debug</code></pre></figure>
<p>Visit the <a href="https://www.mysensors.org/download">library API</a> of MySensors for more information.</p>
:ET